-- Fully improved Delta executor AutoMacro

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Global state
local Running, Paused = false, false

-- Percent coordinates (relative to viewport)
local ButtonXPerc, ButtonYPerc = 0.44, 0.64
local FixedXPerc, FixedYPerc = 0.51, 0.50
local PostEXPerc, PostEYPerc = 0.56, 0.48

-- Detect VirtualInputManager (VIM)
local ok, VIM = pcall(function() return game:GetService("VirtualInputManager") end)
if not ok or not VIM then
    warn("VirtualInputManager not detected. Script will not work properly.")
    return
end

print("VIM detected, script ready.")

-- Converts percentage to absolute screen coordinates
local function toScreen(xPerc, yPerc)
    local vp = Camera.ViewportSize
    return vp.X * xPerc, vp.Y * yPerc
end

-- Click helper using VIM (absolute screen coordinates)
local function clickAt(x, y, button)
    button = button or 0
    VIM:SendMouseButtonEvent(x, y, button, true, game)
    task.wait(0.03)
    VIM:SendMouseButtonEvent(x, y, button, false, game)
end

-- Right-drag helper
local function rightDrag(x, y, deltaY)
    VIM:SendMouseButtonEvent(x, y, 1, true, game) -- right down
    task.wait(0.02)
    VIM:SendMouseMoveEvent(x, y + deltaY, game)
    task.wait(0.02)
    VIM:SendMouseButtonEvent(x, y + deltaY, 1, false, game) -- right up
end

-- Press key helper
local function pressKey(keyEnum, holdTime)
    holdTime = holdTime or 0.05
    VIM:SendKeyEvent(true, keyEnum, false, game)
    task.wait(holdTime)
    VIM:SendKeyEvent(false, keyEnum, false, game)
end

-- Spam key helper
local function spamKey(keyEnum, duration)
    local start = tick()
    while Running and not Paused and tick() - start < duration do
        pressKey(keyEnum, 0.01)
        task.wait(0.02)
    end
end

-- Main loop
local function mainLoop()
    while Running do
        if Paused then
            task.wait(0.1)
            continue
        end

        task.wait(5) -- initial wait

        -- 1️⃣ Click button
        local bx, by = toScreen(ButtonXPerc, ButtonYPerc)
        clickAt(bx, by)

        -- 2️⃣ Click center of screen
        local cx, cy = toScreen(0.5, 0.5)
        clickAt(cx, cy)

        task.wait(10)

        -- 3️⃣ Right-click drag down
        rightDrag(cx, cy, 200)
        task.wait(3)

        -- 4️⃣ Press 1
        pressKey(Enum.KeyCode.One, 0.05)

        -- 5️⃣ Click fixed position
        local fx, fy = toScreen(FixedXPerc, FixedYPerc)
        clickAt(fx, fy)

        -- 6️⃣ First E spam for 60 seconds
        spamKey(Enum.KeyCode.E, 60)

        -- Post-E actions
        if Running and not Paused then
            pressKey(Enum.KeyCode.Q, 0.05)
            pressKey(Enum.KeyCode.One, 0.05)
            local px, py = toScreen(PostEXPerc, PostEYPerc)
            clickAt(px, py)
        end

        -- Second E spam for 45 seconds
        spamKey(Enum.KeyCode.E, 45)
    end
end

-- GUI
local screen = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
screen.ResetOnSpawn = false

local frame = Instance.new("Frame", screen)
frame.Size = UDim2.new(0, 320, 0, 140)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BackgroundTransparency = 0.25
frame.BorderSizePixel = 0

local function makeButton(text, x)
    local b = Instance.new("TextButton", frame)
    b.Size = UDim2.new(0, 90, 0, 35)
    b.Position = UDim2.new(0, x, 0, 60)
    b.Text = text
    b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    b.TextColor3 = Color3.fromRGB(255, 255, 255)
    b.Font = Enum.Font.SourceSansBold
    b.TextSize = 18
    return b
end

local startBtn = makeButton("Start", 0.03)
local pauseBtn = makeButton("Pause", 0.37)
local stopBtn  = makeButton("Stop", 0.70)

local status = Instance.new("TextLabel", frame)
status.Size = UDim2.new(0, 300, 0, 30)
status.Position = UDim2.new(0, 10, 0, 10)
status.BackgroundTransparency = 1
status.TextColor3 = Color3.fromRGB(255, 255, 255)
status.Text = "Status: Stopped"
status.Font = Enum.Font.SourceSansBold
status.TextSize = 20
status.TextXAlignment = Enum.TextXAlignment.Left

-- GUI callbacks
startBtn.MouseButton1Click:Connect(function()
    if Running then return end
    Running, Paused = true, false
    status.Text = "Status: Running"
    task.spawn(mainLoop)
end)

pauseBtn.MouseButton1Click:Connect(function()
    if Running then
        Paused = not Paused
        status.Text = Paused and "Status: Paused" or "Status: Running"
    end
end)

stopBtn.MouseButton1Click:Connect(function()
    Running, Paused = false, false
    status.Text = "Status: Stopped"
end)

-- Emergency stop (press 0)
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Zero then
        Running, Paused = false, false
        status.Text = "Status: Stopped"
    end
end)

print("Fully improved AutoMacro loaded. Start / Pause / Stop ready.")
